<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clicker</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f4f8;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
  }

  .container {
    text-align: center;
    background-color: #fff;
    padding: 40px 20px;
    border-radius: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    max-width: 400px;
    width: 90%;
  }

  h1 {
    margin-bottom: 20px;
    color: #2c3e50;
  }

  /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ */
  #click-button {
    border: none;
    background: none;
    cursor: pointer;
    outline: none;
    display: inline-block;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  #click-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
  @keyframes clickAnimation {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  /* –°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
  #click-image {
    width:300px;
    height:auto;
    border-radius:15px;
    transition: box-shadow 0.3s, filter 0.3s;
  }

  /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
</style>
</head>
<body>

<div class="container">
<h1>{{ collection.name }}</h1>

<button id="click-button">
<img src="{{ url_for('uploaded_file', filename=collection.image_path) }}" alt="{{ collection.name }}" id="click-image" />
</button>

<h2>–°—á–µ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π: <span id="click-count">{{ current_user.click_count or 0 }}</span></h2>
</div>

<script>
const button = document.getElementById('click-button');
const clickCountSpan = document.getElementById('click-count');
const image = document.getElementById('click-image');

button.addEventListener('click', () => {

   // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é "–ø—É–ª—å—Å–∞—Ü–∏–∏" –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   image.style.animation = 'clickAnimation .3s ease';

   // –£–¥–∞–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
   image.addEventListener('animationend', () => {
     image.style.animation = '';
   }, { once:true });

   // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
   fetch(`/api/clicker/{{ collection.id }}/click/{{ current_user.id }}`, {
       method:'POST',
       headers:{'Content-Type':'application/json'}
   })
   .then(res => {
       if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
       return res.json();
   })
   .then(data => {
       if (data.click_count !== undefined) {
           // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–∏—Å–ª–∞
           const currentCount = parseInt(clickCountSpan.textContent);
           const newCount = data.click_count;

           // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∏—Å–ª–∞
           animateNumber(currentCount, newCount);
       }
       if (data.nft_received) {
           alert(`üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ NFT:\n${data.nft_received.name} (${data.nft_received.rarity})`);
       }
   })
   .catch(error => {
       console.error('–û—à–∏–±–∫–∞:', error);
       alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–ª–∏–∫–∞.');
   });
});

// –§—É–Ω–∫—Ü–∏—è –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∏—Å–ª–∞
function animateNumber(start, end) {
   const duration =300; // ms
   const startTime = performance.now();

   function update(currentTime) {
     const elapsed = currentTime - startTime;
     const progress = Math.min(elapsed / duration,1);
     const currentNumber = Math.round(start + (end - start) * progress);
     clickCountSpan.textContent = currentNumber;

     if (progress <1) {
       requestAnimationFrame(update);
     }
   }

   requestAnimationFrame(update);
}
</script>

</body>
</html>